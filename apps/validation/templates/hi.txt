<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Scanner</title>
    <script src="https://kit.fontawesome.com/56f1776af2.js" crossorigin="anonymous"></script>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/scanner.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="../static/scanner.js"></script>

</head>

<body>
    <div class="header">
        <!-- Add the logo container -->
        <div class="logo">
            <img src="../static/logo white transparent.png" alt="logo" width="auto" height="80%">
            <!-- If you have an actual logo image, replace "Your Logo" with an <img> tag -->
        </div>

        <!-- Rest of your content -->
        <label for="field" id="event-name">Event</label>
        <select id="field" name="field" data-name="Field" class="w-select" onchange="selectEvent()">
            <option value="">Select one...</option>
            <option value="event@Frosh23">Slot 1</option>
        </select>
        <!-- ... Rest of your content ... -->
    </div>
    <div style="text-align: center;">
        <span id="error"></span>
    </div>
    <div id="qr-result"></div>
    <div id="funcs">
        <button id="startButton" onclick="startCamera()">Start Camera</button>
        <select id="cameraSelect"></select>
        <div id="videoContainer">
            <video id="video" autoplay playsinline></video>
        </div>

    </div>


    <div class="modal" id="eventModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="container_first">
                <img class="container_img" id="imageUrl" src="" alt="Event Image">
                <div class="modal_data">
                    <h2 id="title" class="title">Hello </h2>
                    <p id="description" class="description">Lorem ipsum Lorem ipsum dolor sit amet consectetur
                        adipisicing
                        elit.
                    </p>
                </div>
            </div>
            <div class="container_second">
                <button class="calender" id="calender"></button>
                <button class="book" id="book">
                    Book now!
                </button>
            </div>
        </div>
    </div>
    

    <script>
        let videoStream;
        const videoElement = document.getElementById('video');
        const cameraSelect = document.getElementById('cameraSelect');
        let selectedDeviceId; // Store the selected camera's deviceId

        // Add an event listener for the "Start Camera" button
        document.getElementById('startButton').addEventListener('click', startCamera);

        async function startCamera() {
            try {
                const mediaDevices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = mediaDevices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    console.error('No video devices found.');
                    return;
                }

                // Update the selectedDeviceId based on the currently selected option in the cameraSelect element
                selectedDeviceId = cameraSelect.value;

                const constraints = { video: { deviceId: selectedDeviceId } };
                if (videoStream) {
                    // Stop the existing stream if it exists
                    videoStream.getTracks().forEach(track => track.stop());
                }
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                updateCameraSelectOptions(videoDevices);

                // Initialize QR code scanner (Add this part back to your code)
                const scanner = new Instascan.Scanner({ video: videoElement });
                scanner.addListener('scan', function (content) {
                    getPassData(content);
                });
                Instascan.Camera.getCameras()
                    .then(function (cameras) {
                        if (cameras.length > 0) {
                            // Start the scanner with the selected camera
                            const selectedCamera = cameras.find(camera => camera.id === selectedDeviceId);
                            scanner.start(selectedCamera);
                        } else {
                            alert('No cameras found.');
                            console.error('No cameras found.');
                        }
                    })
                    .catch(function (error) {
                        alert('Error accessing the camera.' + error);
                        console.error('Error accessing the camera:', error);
                    });

            } catch (error) {
                console.error('Error accessing the camera:', error);
            }
        }

        function updateCameraSelectOptions(videoDevices) {
            cameraSelect.innerHTML = '';
            videoDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = device.label;
                cameraSelect.appendChild(option);
            });
        }

        let scanner = null;
        let cameras = []; // Store available cameras
        let eventkey = "";

        function selectEvent() {
            eventName = document.getElementById("field").value;
            if (eventName == "") {
                document.getElementById("error").innerHTML = "Please select an event";
                document.getElementById("field").style.display = "block";
                document.getElementById("field").disabled = false;
                document.getElementById("event-name").innerHTML = "Select Event";
                document.getElementById("funcs").style.display = "none";
            }
            else {
                eventkey = eventName;
                document.getElementById("error").innerHTML = "";
                document.getElementById("field").disabled = true;
                document.getElementById("field").style.display = "none";
                document.getElementById("event-name").innerHTML = eventName;
                document.getElementById("funcs").style.display = "block";
            }
        }

        function stopCamera() {
            if (scanner) {
                scanner.stop();
                scanner = null;
            }
        }

        function getPassData(pass_id) {

            $.ajax({
                method: "POST",
                url: "/scanner/userdata",
                data: {
                    pass_id: pass_id
                },
                success: function (response) {
                    console.log(response)
                    //alert(response)
                    vibrateForOneSecond()
                    response = JSON.parse(response)
                    openModal(response.event, response.username, response.registration_id, "", "https://eitrawmaterials.eu/wp-content/uploads/2016/09/person-icon.png", "")
                    // console.log(response['username'], response['registration_id'], response['event']);
                },
                error: function (response) {
                    vibrateForOneSecond()
                    toastr.error("Invalid Pass");
                }
            });
        }
    </script>
</body>

</html>