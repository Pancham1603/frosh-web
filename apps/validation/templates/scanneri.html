<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Scanner</title>
    <script src="https://kit.fontawesome.com/56f1776af2.js" crossorigin="anonymous"></script>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/scanner.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="../static/scanner.js"></script>
</head>

<body>
    <div class="logo-container">
        <div class="logo">
            <img src="../static/logo white transparent.png" alt="logo" width="auto" height="80%">
        </div>
    </div>
    <div style="text-align: center;">
        <label for="field" id="event-name">Event</label>
        <select id="field" name="field" data-name="Field" class="w-select" onchange="selectEvent()">
            <option value="">Select one...</option>
            <option value="event@Frosh23">Slot 1</option>

        </select>
        <span id="error"></span>
    </div>
    <div class="sides" id="funcs">
        <button onclick="selectEvent()" id="button">Start Camera</button>
        <button onclick="switchCamera()" id="switch-button">Switch Camera</button>
    </div>

    <div id="qr-result"></div>
    <div id="camera-preview">
        <div class="rectangle" id="rectangle"></div>
    </div>
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="container_first">
                <img class="container_img" id="imageUrl" src="" alt="Event Image">
                <div class="modal_data">
                    <h2 id="title" class="title">Hello </h2>
                    <p id="description" class="description">Lorem ipsum Lorem ipsum dolor sit amet consectetur
                        adipisicing elit.
                    </p>
                </div>
            </div>
            <div class="container_second">
                <button class="calender" id="calender"></button>
                <button class="book" id="book">
                    Book now!
                </button>
            </div>
        </div>
    </div>
    <!-- <button onclick="switchCamera()" id="switch-button">Switch Camera</button> -->

    <script>
        let scanner = null;
        let cameras = []; // Store available cameras
        let eventkey = "";
        let facingMode = "environment";
        function selectEvent() {
            event = document.getElementById("field").value;
            if (event == "") {
                document.getElementById("error").innerHTML = "Please select an event";
                document.getElementById("field").style.display = "block";
                document.getElementById("field").disabled = false;
                document.getElementById("event-name").innerHTML = "Select Event";
                document.getElementById("funcs").style.display = "none";
            }
            else {
                eventkey = event;
                document.getElementById("error").innerHTML = "";
                document.getElementById("field").disabled = true;
                document.getElementById("field").style.display = "none";
                document.getElementById("event-name").innerHTML = event;
                document.getElementById("funcs").style.display = "flex";
                startCamera(0);
            }
        }
        function getCameras() {
            Instascan.Camera.getCameras()
                .then(function (availableCameras) {
                    cameras = availableCameras;

                    // Display camera options in the select element
                    const cameraSelect = document.getElementById("camera-select");

                    // Clear existing options
                    cameraSelect.innerHTML = "";

                    // Add the new camera options
                    cameras.forEach((camera, index) => {
                        const option = document.createElement("option");
                        option.value = index;
                        option.textContent = camera.name;
                        cameraSelect.appendChild(option);
                    });

                    // Enable the switch button  
                    const switchButton = document.getElementById("switch-button");
                    switchButton.textContent = "Switch Camera";
                    switchButton.disabled = false;
                })
                .catch(function (error) {
                    console.error("Error getting cameras:", error);
                });
        }
        function isIOS() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        // Function to get the appropriate facing mode based on the device type
        function getFacingMode() {
            if (isIOS()) {
                // For iOS devices, use "environment" for the back camera and "user" for the front camera
                return facingMode === "environment" ? "user" : "environment";
            } else {
                // For other devices, use the default facing mode
                return facingMode;
            }
        }
        function startCamera() {
            const videoElement = document.createElement("video");
            const cameraPreview = document.getElementById("camera-preview");
            cameraPreview.innerHTML = "";
            cameraPreview.appendChild(videoElement);

            const constraints = { video: { facingMode: currentCameraFacingMode } };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    videoElement.srcObject = stream;
                    videoElement.setAttribute("playsinline", true); // Required to tell iOS safari we don't want fullscreen
                    videoElement.play();
                    scanner = new Instascan.Scanner({ video: video });
                    scanner.addListener("scan", function (content) {
                        console.log(content);
                        getPassData(content);
                    });

                    scanner.start(cameras[selectedCameraIndex]);
                })
                .catch(error => {
                    console.error("Error accessing camera:", error);
                });
        }

        // Call getCameras when the page loads
        getCameras();

        function stopCamera() {
            if (scanner) {
                scanner.stop();
                scanner = null;
            }
        }

        function getPassData(pass_id) {

            $.ajax({
                method: "POST",
                url: "/scanner/userdata",
                data: {
                    pass_id: pass_id
                },
                success: function (response) {
                    console.log(response)
                    //alert(response)
                    vibrateForOneSecond()
                    response = JSON.parse(response)
                    openModal(response.event, response.username, response.registration_id, "", "https://eitrawmaterials.eu/wp-content/uploads/2016/09/person-icon.png", "")
                    // console.log(response['username'], response['registration_id'], response['event']);
                },
                error: function (response) {
                    vibrateForOneSecond()
                    toastr.error("Invalid Pass");
                }
            });
        }
        // Default camera facing mode

        let currentCameraIndex = 0;


        function switchCamera() {
            if (isIOS()) {
                // For iOS devices, toggle the "facingMode" between "environment" and "user"
                facingMode = facingMode === "environment" ? "user" : "environment";

                // Stop the current camera stream and restart the scanner with the new facingMode
                stopCamera();

                alert(currentCameraIndex)
                startCamera(currentCameraIndex);
            } else {
                // For non-iOS devices, use the existing switchCamera() function
                currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
                stopCamera();
                startCamera(currentCameraIndex);
            }
        }

    </script>
    <script src="../static/scanner.js"></script>
    <!-- Add JavaScript for camera and modal functionality here -->

</body>

</html>